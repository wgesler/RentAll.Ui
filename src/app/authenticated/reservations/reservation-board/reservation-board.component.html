<div class="flex content-card-wrap justify-center reservation-board-wrapper" [class.read-only-board]="readOnly">
  <section class="content-card reservation-board-card" [class.read-only-board]="readOnly">
    <div class="flex justify-between items-center gap-3 bg-slate-300 rounded-t-lg py-0 pl-8 pr-4">
      @if (readOnly) {
        <span class="flex-shrink-0 text-xl font-medium read-only-board-title">Reservation Board</span>
      } @else {
        <span class="flex flex-column items-center gap-3 py-4">
          <mat-icon class="flex-shrink-0">grid_view</mat-icon>
          <span class="flex-shrink-0 text-xl font-medium" style="font-size: 2rem;">Reservation Board</span>
        </span>
      }
      <div class="header-date-controls">
        <mat-form-field appearance="outline" class="header-date-field">
          <mat-label>Start Date</mat-label>
          <input
            matInput
            [matDatepicker]="startPicker"
            [(ngModel)]="startDate"
            [ngModelOptions]="{ standalone: true }"
            (dateChange)="onDateRangeChange()"
            [max]="endDate" />
          <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="header-date-field">
          <mat-label>End Date</mat-label>
          <input
            matInput
            [matDatepicker]="endPicker"
            [(ngModel)]="endDate"
            [ngModelOptions]="{ standalone: true }"
            (dateChange)="onDateRangeChange()"
            [min]="startDate" />
          <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>

        <button
          mat-raised-button
          type="button"
          color="primary"
          id="selection-button"
          (click)="goToBoardSelection()"
          class="header-clear-button text-nowrap flex-shrink-0">
          Selection
        </button>
      </div>
    </div>
    <mat-card>
      <div class="board-wrapper">
        <table class="reservation-table">
          <thead>
            <!-- Row 1: Empty property cells + Month headers -->
            <tr class="header-row header-row-1">
              <th class="property-header-cell code-header">&nbsp;</th>
              <th class="property-header-cell address-header">&nbsp;</th>
              <th class="property-header-cell rent-header">&nbsp;</th>
              <th class="property-header-cell beds-header">&nbsp;</th>
              <th class="property-header-cell status-header">&nbsp;</th>
              @for (monthGroup of getMonthGroups(); track monthGroup.monthName) {
                <th class="month-header-cell" [attr.colspan]="monthGroup.days">{{ monthGroup.monthName }}</th>
              }
            </tr>
            <!-- Row 2: Property headers + Day of week -->
            <tr class="header-row header-row-2">
              <th class="property-header-cell code-header">Code</th>
              <th class="property-header-cell address-header">Address</th>
              <th class="property-header-cell rent-header">RENT/M</th>
              <th class="property-header-cell beds-header">B/B</th>
              <th class="property-header-cell status-header">ST</th>
              @for (day of calendarDays; track day.date.getTime()) {
                <th class="dow-header-cell">{{ day.dayOfWeek }}</th>
              }
            </tr>
            <!-- Row 3: Empty property cells + Dates -->
            <tr class="header-row header-row-3">
              <th class="property-header-cell code-header">&nbsp;</th>
              <th class="property-header-cell address-header">&nbsp;</th>
              <th class="property-header-cell rent-header">&nbsp;</th>
              <th class="property-header-cell beds-header">&nbsp;</th>
              <th class="property-header-cell status-header">&nbsp;</th>
              @for (day of calendarDays; track day.date.getTime()) {
                <th class="date-header-cell">{{ day.dayNumber }}</th>
              }
            </tr>
          </thead>
          <tbody>
            @for (property of properties; track property.propertyId) {
              <tr class="property-row">
                <td class="property-cell code-cell">
                  @if (readOnly) {
                    <span>{{ property.propertyCode }}</span>
                  } @else {
                    <a [routerLink]="getPropertyRoute(property.propertyId)">{{ property.propertyCode }}</a>
                  }
                </td>
                <td class="property-cell address-cell">{{ property.address }}</td>
                <td class="property-cell rent-cell">${{ property.monthlyRate }}</td>
                <td class="property-cell beds-cell">{{ property.bedsBaths }}</td>
                <td class="property-cell status-cell">{{ property.statusLetter }}</td>
                @for (day of calendarDays; track day.date.getTime()) {
                  @if (isDateBlockedByAvailability(property, day.date)) {
                    @if (getBlockedAvailabilityColor(); as blockedColor) {
                      <td class="calendar-cell blocked-availability"
                          [style.backgroundColor]="blockedColor"
                          [style.color]="getTextColor(blockedColor)">B</td>
                    } @else {
                      <td class="calendar-cell blocked-availability">B</td>
                    }
                  } @else if (getReservationForPropertyAndDate(property.propertyId, day.date); as reservation) {
                    @if (getReservationColor(reservation, day.date); as bgColor) {
                      @if (getReservationDisplayText(reservation, day.date) === 'A' || getReservationDisplayText(reservation, day.date) === 'D') {
                        @if (getReservationStatusClass(reservation, day.date) === 'reservation-arrival' || getReservationStatusClass(reservation, day.date) === 'reservation-departure') {
                          <td class="calendar-cell" 
                              [ngClass]="getReservationStatusClass(reservation, day.date)" 
                              [style.backgroundColor]="bgColor"
                              [style.color]="getTextColor(bgColor)"
                              (click)="onReservationCellClick(reservation.reservationId)">
                            @if (readOnly) {
                              <span class="reservation-link">{{ getReservationDisplayText(reservation, day.date) }}</span>
                            } @else {
                              <a [routerLink]="getReservationRoute(reservation.reservationId)" class="reservation-link" (click)="$event.stopPropagation()">
                                {{ getReservationDisplayText(reservation, day.date) }}
                              </a>
                            }
                          </td>
                        } @else {
                          <td class="calendar-cell" 
                              [ngClass]="getReservationStatusClass(reservation, day.date)" 
                              [style.backgroundColor]="bgColor"
                              [style.color]="getTextColor(bgColor)"
                              (click)="onReservationCellClick(reservation.reservationId)">
                            {{ getReservationDisplayText(reservation, day.date) }}
                          </td>
                        }
                      } @else {
                        <td class="calendar-cell" 
                            [ngClass]="getReservationStatusClass(reservation, day.date)" 
                            [style.backgroundColor]="bgColor"
                            [style.color]="getTextColor(bgColor)"
                            (click)="onReservationCellClick(reservation.reservationId)">
                          {{ getReservationDisplayText(reservation, day.date) }}
                        </td>
                      }
                    } @else {
                      @if (getReservationDisplayText(reservation, day.date) === 'A' || getReservationDisplayText(reservation, day.date) === 'D') {
                        @if (getReservationStatusClass(reservation, day.date) === 'reservation-arrival' || getReservationStatusClass(reservation, day.date) === 'reservation-departure') {
                          <td class="calendar-cell" [ngClass]="getReservationStatusClass(reservation, day.date)" (click)="onReservationCellClick(reservation.reservationId)">
                            @if (readOnly) {
                              <span class="reservation-link">{{ getReservationDisplayText(reservation, day.date) }}</span>
                            } @else {
                              <a [routerLink]="getReservationRoute(reservation.reservationId)" class="reservation-link" (click)="$event.stopPropagation()">
                                {{ getReservationDisplayText(reservation, day.date) }}
                              </a>
                            }
                          </td>
                        } @else {
                          <td class="calendar-cell" [ngClass]="getReservationStatusClass(reservation, day.date)" (click)="onReservationCellClick(reservation.reservationId)">
                            {{ getReservationDisplayText(reservation, day.date) }}
                          </td>
                        }
                      } @else {
                        <td class="calendar-cell" [ngClass]="getReservationStatusClass(reservation, day.date)" (click)="onReservationCellClick(reservation.reservationId)">
                          {{ getReservationDisplayText(reservation, day.date) }}
                        </td>
                      }
                    }
                  } @else {
                    <td class="calendar-cell" (click)="onEmptyCellClick(property.propertyId, day.date)"> </td>
                  }
                }
              </tr>
            }
          </tbody>
        </table>
      </div>
    </mat-card>
  </section>
</div>
