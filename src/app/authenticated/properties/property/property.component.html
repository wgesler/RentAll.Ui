@if (isLoading$ | async) {
  <div class="loading-container">
    <mat-spinner [diameter]="40"></mat-spinner>
    <p>Loading property...</p>
  </div>
} @else if (!isServiceError) {
  <div class="flex content-card-wrap justify-center">
    <section class="content-card">
      <div class="flex justify-between items-center gap-3 bg-slate-300 rounded-t-lg py-0 pl-8 pr-4">
          <span class="flex flex-column items-center gap-3 py-4">
            <mat-icon class="flex-shrink-0">home</mat-icon>
            <span class="flex-shrink-0 text-xl font-medium">
              {{ isAddMode ? 'Add Property' : 'Edit Property' }}
            </span>
          </span>
        <div class="flex gap-2">
          <button mat-raised-button type="button" color="accent" id="back-button" (click)="back()"
            class="scale-90 text-nowrap flex-shrink-0">
            <mat-icon>arrow_back</mat-icon>
            Back
          </button>
        </div>
      </div>
        
      <mat-card>
        <mat-tab-group [selectedIndex]="selectedTabIndex" class="property-tabs" (selectedTabChange)="onTabChange($event)">
          <mat-tab label="Property">
            @if (form) {
            <form [formGroup]="form" (ngSubmit)="saveProperty()" class="info-form mb-8 pt-5">
              @if (showOfficeDropdown) {
                <!-- Office dropdown row - aligned with other tabs -->
                <div class="flex gap-4 items-center mt-3 px-4 mb-4">
                  <mat-form-field appearance="outline" style="width: 300px;">
                    <mat-label>{{ selectedOffice ? 'Office' : 'All Offices' }}</mat-label>
                    <mat-select formControlName="officeId" (selectionChange)="onOfficeChange()" placeholder="All Offices">
                      <mat-option [value]="null">All Offices</mat-option>
                      @for (office of offices; track office.officeId) {
                        <mat-option [value]="office.officeId">{{ office.name }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>
              }
            
            <!-- First line: IsActive and save button right justified -->
            <div class="mb-4 flex justify-end items-center gap-3">
              <mat-checkbox formControlName="isActive" color="primary">
                Is Active
              </mat-checkbox>
              <button mat-raised-button type="button" color="primary" id="save-button" (click)="saveProperty()"
                class="scale-90 text-nowrap flex-shrink-0" [disabled]="isSubmitting || !form">
                <mat-icon>save</mat-icon>
                Save
              </button>
            </div>
            
            <!-- Second line: PropertyCode, Owner1, Owner2, Owner3 - filling card width -->
            <div class="mb-4 flex items-center gap-3">
              <mat-form-field appearance="outline" class="flex-shrink-0" style="width: 18ch; min-width: 18ch; max-width: 18ch;">
                <mat-label>Property Code</mat-label>
                <input matInput formControlName="propertyCode" maxlength="15" (input)="onCodeInput($event)">
                @if (isAddMode && form.get('propertyCode')?.hasError('required') && form.get('propertyCode')?.touched) {
                  <mat-error>Code is required</mat-error>
                }
              </mat-form-field>
              <mat-form-field appearance="outline" style="flex: 1.2; min-width: 180px;">
                <mat-label>Owner</mat-label>
                <mat-select formControlName="owner1Id">
                  <mat-option value="">Select Owner</mat-option>
                  @for (contact of contacts; track contact.contactId) {
                    <mat-option [value]="contact.contactId">{{ contact.fullName }}</mat-option>
                  }
                </mat-select>
                @if (isAddMode && form.get('owner1Id')?.hasError('required') && form.get('owner1Id')?.touched) {
                  <mat-error>Owner is required</mat-error>
                }
              </mat-form-field>
              <mat-form-field appearance="outline" style="flex: 1.3; min-width: 200px;">
                <mat-label>Owner 2 (Optional)</mat-label>
                <mat-select formControlName="owner2Id">
                  <mat-option [value]="null">Select Owner</mat-option>
                  @for (contact of contacts; track contact.contactId) {
                    <mat-option [value]="contact.contactId">{{ contact.fullName }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
              <mat-form-field appearance="outline" style="flex: 1.3; min-width: 200px;">
                <mat-label>Owner 3 (Optional)</mat-label>
                <mat-select formControlName="owner3Id">
                  <mat-option [value]="null">Select Owner</mat-option>
                  @for (contact of contacts; track contact.contactId) {
                    <mat-option [value]="contact.contactId">{{ contact.fullName }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>

            <mat-accordion multi="true">
            <!-- Basic Rental Information Section -->
            <mat-expansion-panel [expanded]="expandedSections.basic" (opened)="onPanelOpened('basic')" (closed)="onPanelClosed('basic')" class="mb-4">
              <mat-expansion-panel-header>
                <mat-panel-title>Basic Rental Information</mat-panel-title>
              </mat-expansion-panel-header>
              <div class="features-container">
                <!-- Row 1: AvailableFrom, AvailableUntil, Check-In, Check-Out, Min-Stay, Max-Stay -->
                <div class="features-row spread availability-row">
                  <mat-form-field appearance="outline" style="flex: 1.4; min-width: 180px;">
                    <mat-label>Available-From</mat-label>
                    <button mat-icon-button matPrefix type="button" (click)="availableFromPicker.open()">
                      <mat-icon>calendar_today</mat-icon>
                    </button>
                    <input matInput [matDatepicker]="availableFromPicker" formControlName="availableFrom">
                    <mat-datepicker #availableFromPicker></mat-datepicker>
                  </mat-form-field>
                  <mat-form-field appearance="outline" style="flex: 1.4; min-width: 180px;">
                    <mat-label>Available-Until</mat-label>
                    <button mat-icon-button matPrefix type="button" (click)="availableUntilPicker.open()">
                      <mat-icon>calendar_today</mat-icon>
                    </button>
                    <input matInput [matDatepicker]="availableUntilPicker" formControlName="availableUntil">
                    <mat-datepicker #availableUntilPicker></mat-datepicker>
                  </mat-form-field>
                  <mat-form-field appearance="outline" style="flex: 0.9; min-width: 110px;">
                    <mat-label>Check-In</mat-label>
                    <mat-select formControlName="checkInTimeId" required>
                      @for (time of checkInTimes; track time.value) {
                        <mat-option [value]="time.value">{{ time.label }}</mat-option>
                      }
                    </mat-select>
                    @if (form.get('checkInTimeId')?.hasError('required') && form.get('checkInTimeId')?.touched) {
                      <mat-error>Time is required</mat-error>
                    }
                  </mat-form-field>
                  <mat-form-field appearance="outline" style="flex: 0.9; min-width: 110px;">
                    <mat-label>Check-Out</mat-label>
                    <mat-select formControlName="checkOutTimeId" required>
                      @for (time of checkOutTimes; track time.value) {
                        <mat-option [value]="time.value">{{ time.label }}</mat-option>
                      }
                    </mat-select>
                    @if (form.get('checkOutTimeId')?.hasError('required') && form.get('checkOutTimeId')?.touched) {
                      <mat-error>Time is required</mat-error>
                    }
                  </mat-form-field>
                  <mat-form-field appearance="outline" style="flex: 0.8; min-width: 100px;">
                    <mat-label>Min-Stay</mat-label>
                    <input matInput type="text" inputmode="numeric" pattern="[0-9]*" maxlength="4" formControlName="minStay">
                  </mat-form-field>
                  <mat-form-field appearance="outline" style="flex: 0.8; min-width: 100px;">
                    <mat-label>Max-Stay</mat-label>
                    <input matInput type="text" inputmode="numeric" pattern="[0-9]*" maxlength="4" formControlName="maxStay">
                  </mat-form-field>
                </div>
                
                <!-- Row 2: MonthlyRate, DailyRate, DepartureFee, MaidServiceFee -->
                <div class="features-row spread availability-row">
                  <mat-form-field appearance="outline" class="compact-field">
                    <mat-label>Monthly Rate</mat-label>
                    <input matInput type="text" formControlName="monthlyRate" (blur)="formatDecimal('monthlyRate')" (input)="onDecimalInput($event, 'monthlyRate')" (focus)="selectAllOnFocus($event)" required>
                    @if (form.get('monthlyRate')?.hasError('required') && form.get('monthlyRate')?.touched) {
                      <mat-error>Monthly Rate is required</mat-error>
                    }
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="compact-field">
                    <mat-label>Daily Rate</mat-label>
                    <input matInput type="text" formControlName="dailyRate" (blur)="formatDecimal('dailyRate')" (input)="onDecimalInput($event, 'dailyRate')" (focus)="selectAllOnFocus($event)" required>
                    @if (form.get('dailyRate')?.hasError('required') && form.get('dailyRate')?.touched) {
                      <mat-error>Daily Rate is required</mat-error>
                    }
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="compact-field">
                    <mat-label>Departure Fee</mat-label>
                    <input matInput type="text" formControlName="departureFee" (blur)="formatDecimal('departureFee')" (input)="onDecimalInput($event, 'departureFee')" (focus)="selectAllOnFocus($event)" required>
                    @if (form.get('departureFee')?.hasError('required') && form.get('departureFee')?.touched) {
                      <mat-error>Departure Fee is required</mat-error>
                    }
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="compact-field">
                    <mat-label>Maid Service Fee</mat-label>
                    <input matInput type="text" formControlName="maidServiceFee" (blur)="formatDecimal('maidServiceFee')" (input)="onDecimalInput($event, 'maidServiceFee')" (focus)="selectAllOnFocus($event)" required>
                    @if (form.get('maidServiceFee')?.hasError('required') && form.get('maidServiceFee')?.touched) {
                      <mat-error>Maid Service Fee is required</mat-error>
                    }
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="compact-field">
                    <mat-label>Pet Fee</mat-label>
                    <input matInput type="text" formControlName="petFee" (blur)="formatDecimal('petFee')" (input)="onDecimalInput($event, 'petFee')" (focus)="selectAllOnFocus($event)" required>
                    @if (form.get('petFee')?.hasError('required') && form.get('petFee')?.touched) {
                      <mat-error>Pet Fee is required</mat-error>
                    }
                  </mat-form-field>
                </div>
                
                <!-- Row 3: PropertyStyle, PropertyType, PropertyStatus -->
                <div class="features-row spread availability-row">
                  <mat-form-field appearance="outline" class="wide-select">
                    <mat-label>Property Style</mat-label>
                    <mat-select formControlName="propertyStyle" required>
                      @for (style of propertyStyles; track style.value) {
                        <mat-option [value]="style.value">{{ style.label }}</mat-option>
                      }
                    </mat-select>
                    @if (form.get('propertyStyle')?.hasError('required') && form.get('propertyStyle')?.touched) {
                      <mat-error>Property style is required</mat-error>
                    }
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="wide-select">
                    <mat-label>Property Type</mat-label>
                    <mat-select formControlName="propertyType" required>
                      @for (type of propertyTypes; track type.value) {
                        <mat-option [value]="type.value">{{ type.label }}</mat-option>
                      }
                    </mat-select>
                    @if (form.get('propertyType')?.hasError('required') && form.get('propertyType')?.touched) {
                      <mat-error>Property type is required</mat-error>
                    }
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="status-compact">
                    <mat-label>Property Status</mat-label>
                    <mat-select formControlName="propertyStatus" required>
                      @for (status of propertyStatuses; track status.value) {
                        <mat-option [value]="status.value">{{ status.label }}</mat-option>
                      }
                    </mat-select>
                    @if (form.get('propertyStatus')?.hasError('required') && form.get('propertyStatus')?.touched) {
                      <mat-error>Property status is required</mat-error>
                    }
                  </mat-form-field>
                </div>
                
                <!-- Row 4: Bedrooms, Bathrooms, Accommodates, Square Feet, Bed Sizes -->
                <div class="features-row spread availability-row">
                  <mat-form-field appearance="outline" class="equal-field">
                    <mat-label>Bedrooms</mat-label>
                    <input matInput type="text" inputmode="numeric" pattern="[0-9]*" formControlName="bedrooms" placeholder="0" (focus)="selectAllOnFocus($event)" required>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="equal-field">
                    <mat-label>Bathrooms</mat-label>
                    <input matInput type="text" inputmode="numeric" pattern="[0-9.]*" formControlName="bathrooms" placeholder="0" (focus)="selectAllOnFocus($event)" required>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="equal-field">
                    <mat-label>Accommodates</mat-label>
                    <input matInput type="text" inputmode="numeric" pattern="[0-9]*" maxlength="10" formControlName="accomodates" placeholder="0" (focus)="selectAllOnFocus($event)" required>
                    @if (form.get('accomodates')?.hasError('required') && form.get('accomodates')?.touched) {
                      <mat-error>Accommodates is required</mat-error>
                    }
                    @if (form.get('accomodates')?.hasError('min') && form.get('accomodates')?.touched) {
                      <mat-error>Accommodates must be at least 1</mat-error>
                    }
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="equal-field">
                    <mat-label>Square Feet</mat-label>
                    <input matInput type="text" inputmode="numeric" pattern="[0-9]*" formControlName="squareFeet" placeholder="0" (focus)="selectAllOnFocus($event)" required>
                  </mat-form-field>
                </div>
                
                <!-- Row 5: Bedroom1, Bedroom2, Bedroom3, Bedroom4 -->
                <div class="features-row spread availability-row">
                  <mat-form-field appearance="outline" class="compact-select">
                    <mat-label>Bedroom 1</mat-label>
                    <mat-select formControlName="bedroomId1">
                      <mat-option [value]="0">None</mat-option>
                      @for (bedSize of bedSizeTypes; track bedSize.value) {
                        <mat-option [value]="bedSize.value">{{ bedSize.label }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="compact-select">
                    <mat-label>Bedroom 2</mat-label>
                    <mat-select formControlName="bedroomId2">
                      <mat-option [value]="0">None</mat-option>
                      @for (bedSize of bedSizeTypes; track bedSize.value) {
                        <mat-option [value]="bedSize.value">{{ bedSize.label }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="compact-select">
                    <mat-label>Bedroom 3</mat-label>
                    <mat-select formControlName="bedroomId3">
                      <mat-option [value]="0">None</mat-option>
                      @for (bedSize of bedSizeTypes; track bedSize.value) {
                        <mat-option [value]="bedSize.value">{{ bedSize.label }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="compact-select">
                    <mat-label>Bedroom 4</mat-label>
                    <mat-select formControlName="bedroomId4">
                      <mat-option [value]="0">None</mat-option>
                      @for (bedSize of bedSizeTypes; track bedSize.value) {
                        <mat-option [value]="bedSize.value">{{ bedSize.label }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>
            </mat-expansion-panel>

            <!-- Address Section -->
            <mat-expansion-panel [expanded]="expandedSections.address" (opened)="onPanelOpened('address')" (closed)="onPanelClosed('address')" class="mb-4">
              <mat-expansion-panel-header>
                <mat-panel-title>Address</mat-panel-title>
              </mat-expansion-panel-header>
              <div class="features-container">
              <div class="grid grid-cols-4 gap-x-1.5 gap-y-1">
                <!-- Top line: Address1, Address2, Suite -->
                <div class="col-span-4 flex items-center gap-x-1.5">
                  <mat-form-field appearance="outline" class="flex-1">
                    <mat-label>Address 1</mat-label>
                    <input matInput formControlName="address1" required>
                    @if (form.get('address1')?.hasError('required') && form.get('address1')?.touched) {
                      <mat-error>Address 1 is required</mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="flex-1">
                    <mat-label>Address 2</mat-label>
                    <input matInput formControlName="address2">
                  </mat-form-field>

                  <mat-form-field appearance="outline" style="width: 15ch; min-width: 15ch; flex-shrink: 0;">
                    <mat-label>Suite</mat-label>
                    <input matInput formControlName="suite">
                  </mat-form-field>
                </div>

                <!-- Next line: City, State, Zip, Phone -->
                <div class="col-span-4 flex items-center gap-x-1.5">
                  <mat-form-field appearance="outline" style="flex: 1.5;">
                    <mat-label>City</mat-label>
                    <input matInput formControlName="city" required>
                    @if (form.get('city')?.hasError('required') && form.get('city')?.touched) {
                      <mat-error>City is required</mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline" style="flex: 0.5;">
                    <mat-label>State</mat-label>
                    <mat-select formControlName="state" required>
                      <mat-option value="">Select</mat-option>
                      @for (state of states; track state) {
                        <mat-option [value]="state">{{ state }}</mat-option>
                      }
                    </mat-select>
                    @if (form.get('state')?.hasError('required') && form.get('state')?.touched) {
                      <mat-error>State is required</mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="flex-1">
                    <mat-label>Zip Code</mat-label>
                    <input matInput formControlName="zip" required>
                    @if (form.get('zip')?.hasError('required') && form.get('zip')?.touched) {
                      <mat-error>Zip Code is required</mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="flex-1">
                    <mat-label>Phone</mat-label>
                    <input matInput formControlName="phone" (input)="onPhoneInput($event)" (blur)="formatPhone()" maxlength="20" placeholder="(555) 555-5555 or +1 234 567 8900">
                    @if (form.get('phone')?.hasError('pattern') && form.get('phone')?.touched) {
                      <mat-error>Invalid phone format</mat-error>
                    }
                  </mat-form-field>
                </div>

                <!-- Next line: Neighborhood, Cross Street, View, Mailbox -->
                <div class="col-span-4 grid grid-cols-4 gap-x-1.5">
                  <mat-form-field appearance="outline">
                    <mat-label>Neighborhood</mat-label>
                    <input matInput formControlName="neighborhood">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Cross Street</mat-label>
                    <input matInput formControlName="crossStreet">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>View</mat-label>
                    <input matInput formControlName="view">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Mailbox</mat-label>
                    <input matInput formControlName="mailbox">
                  </mat-form-field>
                </div>
              </div>
              </div>
            </mat-expansion-panel>

            <!-- Location Section -->
            <mat-expansion-panel [expanded]="expandedSections.location" (opened)="onPanelOpened('location')" (closed)="onPanelClosed('location')" class="mb-4">
              <mat-expansion-panel-header>
                <mat-panel-title>Location</mat-panel-title>
              </mat-expansion-panel-header>
              <div class="features-container">
                <div class="grid grid-cols-4 gap-x-1.5 gap-y-4 features-content">
                  <mat-form-field appearance="outline" class="col-span-1">
                    <mat-label>Office</mat-label>
                    @if (isAddMode) {
                      <input matInput [value]="selectedOffice ? selectedOffice.name : ''" readonly [disabled]="true">
                    } @else {
                      <mat-select formControlName="officeId" required>
                        <mat-option [value]="null">Select Office</mat-option>
                        @for (f of offices; track f.officeId) {
                          <mat-option [value]="f.officeId">{{ f.name }}</mat-option>
                        }
                      </mat-select>
                      @if (form.get('officeId')?.hasError('required') && form.get('officeId')?.touched) {
                        <mat-error>Office is required</mat-error>
                      }
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="col-span-1">
                    <mat-label>Region</mat-label>
                    <mat-select formControlName="regionId">
                      <mat-option [value]="null">Select Region</mat-option>
                      @for (r of regions; track r.regionId) {
                        <mat-option [value]="r.regionId">{{ r.regionCode }} - {{ r.name }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="col-span-1">
                    <mat-label>Area</mat-label>
                    <mat-select formControlName="areaId">
                      <mat-option [value]="null">Select Area</mat-option>
                      @for (a of areas; track a.areaId) {
                        <mat-option [value]="a.areaId">{{ a.areaCode }} - {{ a.name }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="col-span-1">
                    <mat-label>Building</mat-label>
                    <mat-select formControlName="buildingId">
                      <mat-option [value]="null">Select Building</mat-option>
                      @for (b of buildings; track b.buildingId) {
                        <mat-option [value]="b.buildingId">{{ b.buildingCode }} - {{ b.name }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>
            </mat-expansion-panel>

            <!-- Features & Security Section -->
            <mat-expansion-panel [expanded]="expandedSections.features" (opened)="onPanelOpened('features')" (closed)="onPanelClosed('features')" class="mb-4">
              <mat-expansion-panel-header>
                <mat-panel-title>Features & Security</mat-panel-title>
              </mat-expansion-panel-header>
              <div class="features-container">
                <!-- Line 1: Unfurnished, Heating, AC, Elevator, Security, Gated -->
                <div class="flex items-center justify-between mb-4" style="padding-right: 46px;">
                  <mat-checkbox formControlName="unfurnished">Unfurnished</mat-checkbox>
                  <mat-checkbox formControlName="heating">Heating</mat-checkbox>
                  <mat-checkbox formControlName="ac">AC</mat-checkbox>
                  <mat-checkbox formControlName="elevator">Elevator</mat-checkbox>
                  <mat-checkbox formControlName="security">Security</mat-checkbox>
                  <mat-checkbox formControlName="gated">Gated</mat-checkbox>
                </div>

                <!-- Line 2: Alarm, Code, Keypad Access, Master Key Code, Tenant Key Code -->
                <div class="flex items-center gap-4 mb-4">
                  <mat-checkbox formControlName="alarm">Alarm</mat-checkbox>
                  <mat-form-field appearance="outline" style="width: 18ch; min-width: 18ch;">
                    <mat-label>Code</mat-label>
                    <input matInput formControlName="alarmCode" maxlength="6">
                  </mat-form-field>
                  <mat-checkbox formControlName="keypadAccess">Keypad Access</mat-checkbox>
                  <mat-form-field appearance="outline" class="flex-1" style="min-width: 15ch;">
                    <mat-label>Master Key Code</mat-label>
                    <input matInput formControlName="masterKeyCode" maxlength="10">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="flex-1" style="min-width: 15ch;">
                    <mat-label>Tenant Key Code</mat-label>
                    <input matInput formControlName="tenantKeyCode" maxlength="10">
                  </mat-form-field>
                </div>

                <!-- Line 3: Pets Allowed, DogsOkay, CatsOkay, Pound Limit, Parking, Parking Notes -->
                <div class="flex items-center gap-4 mb-4">
                  <mat-checkbox formControlName="petsAllowed">Pets Allowed</mat-checkbox>
                  <mat-checkbox formControlName="dogsOkay">DogsOkay</mat-checkbox>
                  <mat-checkbox formControlName="catsOkay">CatsOkay</mat-checkbox>
                  <mat-form-field appearance="outline" class="flex-1" style="min-width: 15ch;">
                    <mat-label>Pound Limit / Notes</mat-label>
                    <input matInput formControlName="poundLimit">
                  </mat-form-field>
                  <mat-checkbox formControlName="parking">Parking</mat-checkbox>
                  <mat-form-field appearance="outline" class="flex-1">
                    <mat-label>Parking Notes</mat-label>
                    <input matInput formControlName="parkingNotes">
                  </mat-form-field>
                </div>
              </div>
            </mat-expansion-panel>

            <!-- Kitchen Section -->
            <mat-expansion-panel [expanded]="expandedSections.kitchen" (opened)="onPanelOpened('kitchen')" (closed)="onPanelClosed('kitchen')" class="mb-4">
              <mat-expansion-panel-header>
                <mat-panel-title>Kitchen & Bath</mat-panel-title>
              </mat-expansion-panel-header>
              <div class="grid grid-cols-4 gap-x-1.5 gap-y-4">
                <div class="col-span-4">
                  <div class="features-container">
                  <div class="grid grid-cols-4 gap-4 items-center features-content">
                    <mat-checkbox formControlName="kitchen">Kitchen</mat-checkbox>
                    <mat-checkbox formControlName="oven">Oven</mat-checkbox>
                    <mat-checkbox formControlName="refrigerator">Refrigerator</mat-checkbox>
                    <mat-checkbox formControlName="microwave">Microwave</mat-checkbox>
                    <mat-checkbox formControlName="dishwasher">Dishwasher</mat-checkbox>
                    <mat-checkbox formControlName="bathtub">Bathtub</mat-checkbox>
                    <mat-checkbox formControlName="washerDryer">Washer/Dryer</mat-checkbox>
                    <mat-checkbox formControlName="sofabeds">Sofabeds</mat-checkbox>
                  </div>
                  </div>
                </div>
              </div>
            </mat-expansion-panel>

            <!-- Electronics Section -->
            <mat-expansion-panel [expanded]="expandedSections.electronics" (opened)="onPanelOpened('electronics')" (closed)="onPanelClosed('electronics')" class="mb-4">
              <mat-expansion-panel-header>
                <mat-panel-title>Electronics</mat-panel-title>
              </mat-expansion-panel-header>
              <div class="grid grid-cols-4 gap-x-1.5 gap-y-4">
                <div class="col-span-4">
                  <div class="features-container">
                    <div class="grid grid-cols-4 gap-4 items-center features-content">
                      <mat-checkbox formControlName="tv">TV</mat-checkbox>
                      <mat-checkbox formControlName="cable">Cable</mat-checkbox>
                      <mat-checkbox formControlName="streaming">Streaming</mat-checkbox>
                      <mat-checkbox formControlName="fastInternet">Fast Internet</mat-checkbox>
                    </div>
                  </div>
                </div>
                <div class="col-span-4 grid grid-cols-2 gap-x-1.5">
                  <mat-form-field appearance="outline">
                    <mat-label>Internet Network</mat-label>
                    <input matInput formControlName="internetNetwork">
                  </mat-form-field>
                  <mat-form-field appearance="outline">
                    <mat-label>Internet Password</mat-label>
                    <input matInput formControlName="internetPassword">
                  </mat-form-field>
                </div>
              </div>
            </mat-expansion-panel>

            <!-- Outdoor Spaces Section -->
            <mat-expansion-panel [expanded]="expandedSections.outdoor" (opened)="onPanelOpened('outdoor')" (closed)="onPanelClosed('outdoor')" class="mb-4">
              <mat-expansion-panel-header>
                <mat-panel-title>Outdoor Spaces</mat-panel-title>
              </mat-expansion-panel-header>
              <div class="grid grid-cols-4 gap-x-1.5 gap-y-4">
                <div class="col-span-4">
                  <div class="features-container">
                  <div class="grid grid-cols-4 gap-4 items-center features-content">
                    <mat-checkbox formControlName="deck">Deck</mat-checkbox>
                    <mat-checkbox formControlName="patio">Patio</mat-checkbox>
                    <mat-checkbox formControlName="yard">Yard</mat-checkbox>
                    <mat-checkbox formControlName="garden">Garden</mat-checkbox>
                  </div>
                  </div>
                </div>
              </div>
            </mat-expansion-panel>

            <!-- Pool & Spa Section -->
            <mat-expansion-panel [expanded]="expandedSections.pool" (opened)="onPanelOpened('pool')" (closed)="onPanelClosed('pool')" class="mb-4">
              <mat-expansion-panel-header>
                <mat-panel-title>Pool & Spa</mat-panel-title>
              </mat-expansion-panel-header>
              <div class="grid grid-cols-4 gap-x-1.5 gap-y-4">
                <div class="col-span-4">
                  <div class="features-container">
                  <div class="grid grid-cols-5 gap-4 items-center features-content">
                    <mat-checkbox formControlName="commonPool">Common Pool</mat-checkbox>
                    <mat-checkbox formControlName="privatePool">Private Pool</mat-checkbox>
                    <mat-checkbox formControlName="jacuzzi">Jacuzzi</mat-checkbox>
                    <mat-checkbox formControlName="sauna">Sauna</mat-checkbox>
                    <mat-checkbox formControlName="gym">Gym</mat-checkbox>
                  </div>
                  </div>
                </div>
              </div>
            </mat-expansion-panel>

            <!-- Trash Section -->
            <mat-expansion-panel [expanded]="expandedSections.trash" (opened)="onPanelOpened('trash')" (closed)="onPanelClosed('trash')" class="mb-4">
              <mat-expansion-panel-header>
                <mat-panel-title>Trash</mat-panel-title>
              </mat-expansion-panel-header>
              <div class="grid grid-cols-4 gap-x-1.5 gap-y-4">
                <div class="col-span-4">
                  <div class="features-container">
                  <div class="grid grid-cols-4 gap-x-1.5 items-center features-content">
                    <mat-form-field appearance="outline" class="col-span-1">
                      <mat-label>Pickup</mat-label>
                      <mat-select formControlName="trashPickupId">
                        <mat-option value="">Select Day</mat-option>
                        @for (day of trashDays; track day.value) {
                          <mat-option [value]="day.value">{{ day.label }}</mat-option>
                        }
                      </mat-select>
                      @if (form.get('trashPickupId')?.hasError('required') && form.get('trashPickupId')?.touched) {
                        <mat-error>Trash pickup is required</mat-error>
                      }
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="col-span-3">
                      <mat-label>Removal</mat-label>
                      <input matInput formControlName="trashRemoval">
                    </mat-form-field>
                  </div>
                  </div>
                </div>
              </div>
            </mat-expansion-panel>

            <!-- Additional Amenities Section -->
            <mat-expansion-panel [expanded]="expandedSections.amenities" (opened)="onPanelOpened('amenities')" (closed)="onPanelClosed('amenities')" class="mb-4">
              <mat-expansion-panel-header>
                <mat-panel-title>Additional Amenities</mat-panel-title>
              </mat-expansion-panel-header>
              <div class="grid grid-cols-4 gap-x-1.5 gap-y-1">
                <mat-form-field appearance="outline" class="col-span-4">
                  <mat-label>Additional Amenities</mat-label>
                  <textarea matInput formControlName="amenities" rows="3"></textarea>
                </mat-form-field>
              </div>
            </mat-expansion-panel>

            <!-- Description Section -->
            <mat-expansion-panel [expanded]="expandedSections.description" (opened)="onPanelOpened('description')" (closed)="onPanelClosed('description')" class="mb-4">
              <mat-expansion-panel-header>
                <mat-panel-title>Description</mat-panel-title>
              </mat-expansion-panel-header>
              <div class="grid grid-cols-4 gap-x-1.5 gap-y-1">
                <mat-form-field appearance="outline" class="col-span-4">
                  <mat-label>Description</mat-label>
                  <textarea matInput formControlName="description" rows="3"></textarea>
                </mat-form-field>
              </div>
            </mat-expansion-panel>
            </mat-accordion>

            <!-- Notes Section -->
            <div class="grid grid-cols-4 gap-x-1.5 gap-y-1 mt-4">
              <mat-form-field appearance="outline" class="col-span-4">
                <mat-label>Notes</mat-label>
                <textarea matInput formControlName="notes" rows="3"></textarea>
              </mat-form-field>
            </div>

            @if (isSubmitting) {
              <div class="flex justify-start gap-3 items-center">
                <mat-spinner [diameter]="20" color="accent" class="inline-block relative right-1 m-1"/>
                <span>Saving...</span>
              </div>
            }
        </form>
            }
          </mat-tab>
          
          <mat-tab label="Information">
            <app-property-information 
              [propertyId]="isAddMode ? null : propertyId" 
              [copiedPropertyInformation]="copiedPropertyInformation"
              [officeId]="selectedOffice?.officeId || form?.get('officeId')?.value || null"
              [propertyCode]="form?.get('propertyCode')?.value || property?.propertyCode || null">
            </app-property-information>
          </mat-tab>
          
          <mat-tab label="Welcome Letter">
            <app-property-welcome-letter 
              [propertyId]="isAddMode ? null : propertyId"
              [externalReservationId]="selectedReservationId"
              [officeId]="form?.get('officeId')?.value || null"
              [propertyCode]="form?.get('propertyCode')?.value || property?.propertyCode || null"
              (reservationSelected)="onWelcomeLetterReservationSelected($event)"
              (officeIdChange)="onWelcomeLetterOfficeIdChange($event)">
            </app-property-welcome-letter>
          </mat-tab>

          <mat-tab label="Emails">
            <app-email-list
              #propertyEmailList
              [propertyId]="isAddMode ? null : propertyId"
              [propertyCode]="form?.get('propertyCode')?.value || property?.propertyCode || null"
              [officeId]="selectedOffice?.officeId || form?.get('officeId')?.value || null"
              [reservationId]="selectedReservationId"
              [emailTypeId]="EmailType.PropertyLetter"
              [source]="'property'"
              [hideHeader]="true"
              (reservationIdChange)="onEmailReservationSelected($event)"
              (officeIdChange)="onEmailOfficeIdChange($event)">
            </app-email-list>
          </mat-tab>
          
          <mat-tab label="Documents">
            <app-document-list 
              #propertyDocumentList
              [propertyId]="isAddMode ? null : propertyId" 
              [propertyCode]="form?.get('propertyCode')?.value || property?.propertyCode || null"
              [documentTypeId]="DocumentType.PropertyLetter"
              [officeId]="selectedOffice?.officeId || form?.get('officeId')?.value || null"
              [reservationId]="selectedReservationId"
              [source]="'property'"
              (reservationIdChange)="onDocumentsReservationSelected($event)"
              (officeIdChange)="onDocumentOfficeIdChange($event)"
              [hideHeader]="true">
            </app-document-list>
          </mat-tab>
        </mat-tab-group>
      </mat-card>
    </section>
  </div>
}

