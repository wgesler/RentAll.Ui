@if (isLoading$ | async) {
  <div class="loading-container">
    <mat-spinner [diameter]="40"></mat-spinner>
    <p>Loading lease...</p>
  </div>
} @else {
  <div class="lease-container">
    <form [formGroup]="form" class="lease-form">
      
      <!-- Action Buttons Section -->
      <div class="top-controls">
        <div class="flex gap-2">
          <button mat-raised-button type="button" color="accent" (click)="onPrint()" 
            [disabled]="!selectedOffice || !selectedReservation || !previewIframeHtml">
            <mat-icon>print</mat-icon>
            Print
          </button>
          <button mat-raised-button type="button" color="accent" (click)="onEmail()" 
            [disabled]="!selectedOffice || !selectedReservation || !previewIframeHtml || !contact?.email">
            <mat-icon>email</mat-icon>
            Email
          </button>
          <button mat-raised-button type="button" color="accent" (click)="onDownload()" 
            [disabled]="!selectedOffice || !selectedReservation || !previewIframeHtml || isDownloading">
            <mat-icon>download</mat-icon>
            {{ isDownloading ? 'Downloading...' : 'Download' }}
          </button>
          <button mat-raised-button type="button" color="primary" id="save-button" 
            (click)="form.get('selectedReservationId')?.value && selectedOffice && selectedReservation ? saveLeaseAsDocument() : saveLease()"
            class="scale-90 text-nowrap flex-shrink-0" [disabled]="isSubmitting">
            <mat-icon>save</mat-icon>
            Save
          </button>
        </div>
      </div>

      <!-- Input Fields Section -->
      <div class="input-controls">
        <div class="flex gap-3 items-center">
          <!-- Property Code (readonly) -->
          <mat-form-field appearance="outline" class="property-code-field">
            <mat-label>Property Code</mat-label>
            <input matInput [value]="property?.propertyCode || ''" readonly>
          </mat-form-field>

          <!-- Office Name (readonly) -->
          <mat-form-field appearance="outline" class="office-dropdown">
            <mat-label>Office</mat-label>
            <input matInput [value]="selectedReservation?.officeName || ''" readonly>
          </mat-form-field>

          <!-- Reservation Dropdown -->
          <mat-form-field appearance="outline" class="reservation-dropdown">
            <mat-label>Reservation</mat-label>
            <mat-select formControlName="selectedReservationId" (selectionChange)="onReservationSelected($event.value)" [disabled]="!selectedOffice">
              <mat-option [value]="null">Select Reservation</mat-option>
              @for (reservation of availableReservations; track reservation.value.reservationId) {
                <mat-option [value]="reservation.value.reservationId">
                  {{ reservation.label }}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

      <!-- Include Checkboxes Section -->
      <div class="include-controls">
        <span class="include-label">Include:</span>
          <mat-checkbox formControlName="includeLease" class="include-checkbox" (change)="onIncludeCheckboxChange()">
            Lease
          </mat-checkbox>
          <mat-checkbox formControlName="includeLetterOfResponsibility" class="include-checkbox" (change)="onIncludeCheckboxChange()">
            Letter of Responsibility
          </mat-checkbox>
          <mat-checkbox formControlName="includeNoticeToVacate" class="include-checkbox" (change)="onIncludeCheckboxChange()">
            Notice to Vacate
          </mat-checkbox>
          <mat-checkbox formControlName="includeCreditCardAuthorization" class="include-checkbox" (change)="onIncludeCheckboxChange()">
          Credit Card Authorization
        </mat-checkbox>
          <mat-checkbox *ngIf="isCompanyRental" formControlName="includeBusinessCreditApplication" class="include-checkbox" (change)="onIncludeCheckboxChange()">
          Business Credit Application
        </mat-checkbox>
          <mat-checkbox *ngIf="!isCompanyRental" formControlName="includeRentalCreditApplication" class="include-checkbox" (change)="onIncludeCheckboxChange()">
            Rental Credit Application
          </mat-checkbox>
        </div>
      </div>


      <!-- Lease Editor or Preview -->
      <div class="editor-section">
        @if (previewIframeHtml) {
          <!-- Preview iframe when lease HTML is available -->
          <div class="preview-section">
            <iframe 
              [srcdoc]="safeHtml" 
              class="preview-iframe"
              [attr.key]="iframeKey"
              (load)="injectStylesIntoIframe()"
              frameborder="0">
            </iframe>
          </div>
        } @else {
          <!-- Editor textarea when preview is not available -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Lease (HTML)</mat-label>
            <textarea 
              matInput 
              formControlName="lease" 
              rows="20"
              [placeholder]="'Enter your lease HTML here. Use {{propertyAddress}} and other placeholders in double curly brackets for dynamic content.'">
            </textarea>
            <mat-hint>
              Use placeholders like {{ '{' }}{{ '{' }}propertyAddress{{ '}' }}{{ '}' }}, {{ '{' }}{{ '{' }}tenantName{{ '}' }}{{ '}' }}, etc. These will be replaced with actual values when generating the lease. Select an Office and Reservation to see the preview.
            </mat-hint>
          </mat-form-field>
        }
      </div>

    </form>
  </div>
}
