@if (isLoading$ | async) {
  <div class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
  </div>
} @else if (!isServiceError) {
  <div class="flex content-card-wrap justify-center">
    <section class="content-card">
      <div class="flex justify-between items-center gap-3 bg-slate-300 rounded-t-lg py-0 pl-8 pr-4">
        <span class="flex flex-column items-center gap-3 py-4">
          <mat-icon class="flex-shrink-0">description</mat-icon>
          <span class="flex-shrink-0 text-xl font-medium">
            {{ isAddMode ? 'Add Document' : 'Edit Document' }}
          </span>
        </span>
        <div class="flex gap-2">
          <button mat-raised-button type="button" color="accent" id="back-button" (click)="back()"
            class="scale-90 text-nowrap flex-shrink-0">
            <mat-icon>arrow_back</mat-icon>
            Back
          </button>
        </div>
      </div>
        
      <mat-card>
        <form [formGroup]="form" (ngSubmit)="saveDocument()" class="info-form mb-8 pt-5">
          <!-- First line: IsDeleted and save button right justified -->
          <div class="mb-4 flex justify-end items-center gap-3">
            <mat-checkbox formControlName="isDeleted" color="primary">
              Is Deleted
            </mat-checkbox>
            <button mat-raised-button type="button" color="primary" id="save-button" (click)="saveDocument()"
              class="scale-90 text-nowrap flex-shrink-0" [disabled]="isSubmitting || !form || !form.valid">
              <mat-icon>save</mat-icon>
              Save
            </button>
          </div>

          <!-- Document Type and Office -->
          <div class="mb-4 flex items-center gap-3">
            <mat-form-field appearance="outline" style="flex: 1; min-width: 200px;">
              <mat-label>Document Type</mat-label>
              <mat-select formControlName="documentType" required>
                <mat-option value="">Select Type</mat-option>
                @for (docType of documentTypes; track docType.value) {
                  <mat-option [value]="docType.value">{{ docType.label }}</mat-option>
                }
              </mat-select>
              @if (form.get('documentType')?.hasError('required') && form.get('documentType')?.touched) {
                <mat-error>Document Type is required</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" style="flex: 1; min-width: 200px;">
              <mat-label>Office</mat-label>
              <mat-select formControlName="officeId">
                <mat-option [value]="null">None</mat-option>
                @for (office of offices; track office.officeId) {
                  <mat-option [value]="office.officeId">{{ office.name }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <!-- File Information -->
          <div class="mb-4 flex items-center gap-3">
            <mat-form-field appearance="outline" style="flex: 1; min-width: 200px;">
              <mat-label>File Name</mat-label>
              <input matInput formControlName="fileName" required>
              @if (form.get('fileName')?.hasError('required') && form.get('fileName')?.touched) {
                <mat-error>File Name is required</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" style="flex: 0.5; min-width: 120px;">
              <mat-label>File Extension</mat-label>
              <input matInput formControlName="fileExtension" required>
              @if (form.get('fileExtension')?.hasError('required') && form.get('fileExtension')?.touched) {
                <mat-error>File Extension is required</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" style="flex: 1; min-width: 200px;">
              <mat-label>Content Type</mat-label>
              <input matInput formControlName="contentType" required>
              @if (form.get('contentType')?.hasError('required') && form.get('contentType')?.touched) {
                <mat-error>Content Type is required</mat-error>
              }
            </mat-form-field>
          </div>

          <!-- File Upload Section -->
          <div class="mb-4">
            <h3 class="pt-3 mb-3">File</h3>
            <div class="flex justify-start items-start mb-4 gap-4">
              @if (fileDetails && fileDetails.file) {
                <!-- Display existing file (from API or newly selected) -->
                <div class="flex flex-col items-start">
                  @if (filePreview) {
                    <!-- Image preview -->
                    <img class="object-contain max-w-xs max-h-44 border-2 border-gray-300 rounded p-2" id="file-preview" alt="File Preview" title="File Preview" [src]="filePreview" />
                  } @else {
                    <!-- Non-image file icon/placeholder -->
                    <div class="flex items-center justify-center max-w-xs max-h-44 border-2 border-gray-300 rounded p-8">
                      <mat-icon class="text-6xl text-gray-400">description</mat-icon>
                    </div>
                  }
                  @if (fileDetails.fileName) {
                    <span class="text-sm font-semibold mt-2">{{ fileDetails.fileName }}</span>
                  }
                </div>
                <div class="flex flex-col gap-2">
                  <button class="myfilebrowser" type="button" id="file-button" color="primary" mat-raised-button (click)="fileInput.click()" style="width: auto; min-width: 120px;">
                    Choose File
                  </button>
                  <button type="button" color="accent" mat-raised-button (click)="removeFile()" style="width: auto; min-width: 120px;">
                    Remove File
                  </button>
                </div>
              } @else {
                <!-- No file selected - show file input button -->
                <button class="myfilebrowser mb-3 mr-2" type="button" id="file-button" color="primary" mat-raised-button (click)="fileInput.click()">
                  Choose File
                </button>
              }
              <!-- Hidden file input -->
              <input 
                type="file" 
                #fileInput
                id="fileInput"
                (change)="onFileSelected($event)" 
                accept="*/*"
                style="display: none;">
            </div>
          </div>

        </form>
      </mat-card>
    </section>
  </div>
}

